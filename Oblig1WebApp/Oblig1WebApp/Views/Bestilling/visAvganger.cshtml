@using Oblig1WebApp.Models
@model IEnumerable<Oblig1WebApp.Models.Bestilling>

<head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="icon" href="favicon.ico" type="image/ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

 
    <script type="text/javascript">
        // Ajax
        $(function () {
            // Kaller på hentAlleVisAvganger og bygger opp tabellRad når siden lastes
            $.ajax({
                url: '/Avgang/hentAlleVisAvganger',
                type: 'GET',
                dataType: 'json',
                success: function (jsVisAvgang) {
                    VisTabellRad(jsVisAvgang);
                    VisDropDown(jsVisAvgang);
                }
            });

            // Oppretter en hendelse på tabellraden når siden lastes
            $("#tabellRad").change(function () {
                var id = $(this).val();
                $.ajax({
                    url: '/Avgang/hentVisAvgangInfo/' + id,
                    type: 'GET',
                    dataType: 'json',
                    success: function (visAvgang) {
                        VisInfoAvgang(visAvgang);
                    }
                });
            });

            $("#drop").change(function () {
                var id = $(this).val();
                $.ajax({
                    url: '/Avgang/hentVisAvgangInfo/' + id,
                    type: 'GET',
                    dataType: 'json',
                    success: function (visAvgang) {
                        VisInfoAvgang(visAvgang);
                    }
                });
            });
        })

        // Setter forsteAvgang inn i span
        function VisTabellRad(jsVisAvgang) {
            var utStrengForste = "";
            var utStrengSiste = "";
            var utStrengTid = "";
            var utStrengSpor = "";
            var utStrengTogNr = "";

            for (var i in jsVisAvgang) {
                utStrengForste += jsVisAvgang[i].forsteAvgang + "<br/>";
                utStrengSiste += jsVisAvgang[i].sisteAvgang + "<br/>";
                utStrengTid += jsVisAvgang[i].reiseTid + "<br/>";
                utStrengSpor += jsVisAvgang[i].spor + "<br/>";
                utStrengTogNr += jsVisAvgang[i].togNummer + "<br/>";
            }

            $("#forste").append(utStrengForste);
            $("#siste").append(utStrengSiste);
            $("#tid").append(utStrengTid);
            $("#spor").append(utStrengSpor);
            $("#nr").append(utStrengTogNr);
        }

        function VisDropDown(jsVisAvgang) {
            var utStreng = "";
            for (var i in jsVisAvgang) {
                utStreng += "<option value='" + jsVisAvgang[i].id + "'>" + jsVisAvgang[i].avgangstid + "</option>";
            }
            $("#drop").append(utStreng);
        }

        function VisInfoAvgang(visAvgang) {
            var utStreng = visAvgang.avgangstid;
            $("#avgangstid").html(utStreng);
        }

        $(function () {
            // Kaller på hentAlleVisAvganger og bygger opp tabellRad når siden lastes
            $.ajax({
                url: '/Avgang/hentAlleVisAvganger',
                type: 'GET',
                dataType: 'json',
                success: function (jsVisAvgang) {
                    VisTabellRadRetur(jsVisAvgang);
                    VisDropDownRetur(jsVisAvgang);
                }
            });

            // Oppretter en hendelse på tabellraden når siden lastes
            $("#tabellRadRetur").change(function () {
                var id = $(this).val();
                $.ajax({
                    url: '/Avgang/hentVisAvgangInfo/' + id,
                    type: 'GET',
                    dataType: 'json',
                    success: function (visAvgang) {
                        VisInfoAvgang(visAvgang);
                    }
                });
            });

            $("#dropRetur").change(function () {
                var id = $(this).val();
                $.ajax({
                    url: '/Avgang/hentVisAvgangInfo/' + id,
                    type: 'GET',
                    dataType: 'json',
                    success: function (visAvgang) {
                        VisInfoAvgang(visAvgang);
                    }
                });
            });
        })

        // Setter forsteAvgang inn i span
        function VisTabellRadRetur(jsVisAvgang) {
            var utStrengSiste = "";
            var utStrengForste = "";
            var utStrengTid = "";
            var utStrengSpor = "";
            var utStrengTogNr = "";

            for (var i in jsVisAvgang) {
                utStrengSiste += jsVisAvgang[i].sisteAvgang + "<br/>";
                utStrengForste += jsVisAvgang[i].forsteAvgang + "<br/>";
                utStrengTid += jsVisAvgang[i].reiseTid + "<br/>";
                utStrengSpor += jsVisAvgang[i].spor + "<br/>";
                utStrengTogNr += jsVisAvgang[i].togNummer + "<br/>";
            }
            
            $("#returforste").append(utStrengForste);
            $("#retursiste").append(utStrengSiste);
            $("#returtid").append(utStrengTid);
            $("#returspor").append(utStrengSpor);
            $("#returnr").append(utStrengTogNr);
        }

        function VisDropDownRetur(jsVisAvgang) {
            var utStreng = "";
            for (var i in jsVisAvgang) {
                utStreng += "<option value='" + jsVisAvgang[i].id + "'>" + jsVisAvgang[i].avgangstidRetur + "</option>";
            }
            $("#dropRetur").append(utStreng);
        }
    </script>
    <script>
        //Validering av valg avgangstid
        $(document).ready(function () {
            $("#regBestilling3").click(function (evt) {
                var dropAvgang = document.getElementById('drop').value;
                var dropAvgangRetur = document.getElementById('dropRetur').value;

                if (dropAvgang.length == 0) {
                    evt.preventDefault()
                    document.getElementById("avgangValidering").innerHTML = "*Vennligst velg en avgangstid*";
                    document.getElementById("avgangValidering").style.color = "red";

                    $("#drop").on('change', function () {
                        var ok = "";
                        $("#avgangValidering").html(ok);
                    });
                }

                var sessionRetur = "@Session["returDato"]";
                if (sessionRetur != "") {
                    if (dropAvgangRetur.length == 0) {
                        evt.preventDefault()
                        document.getElementById("avgangValideringRetur").innerHTML = "*Vennligst velg retur avgangstid*";
                        document.getElementById("avgangValideringRetur").style.color = "red";

                        $("#dropRetur").on('change', function () {
                            var ok = "";
                            $("#avgangValideringRetur").html(ok);
                        });
                    }
                }
            });
        });
    </script>

</head>
<body>
    @{
        var utreiseDato =  Session["utreiseDato"] == null? "" : Session["utreiseDato"].ToString();
        string fjern = "12:00:00 AM";
        string resultatUt = string.Empty;
        int i = utreiseDato.IndexOf(fjern);
        if(i >= 0)
        {
            resultatUt = utreiseDato.Remove(i, fjern.Length);
        }

        var returDato = "";
        string resultatRetur = string.Empty;
        if (Session["returDato"] != null)
        {
            returDato += Session["returDato"] == null ? "" : Session["returDato"].ToString();
            i = returDato.IndexOf(fjern);
            if(i >= 0)
            {
                resultatRetur = returDato.Remove(i, fjern.Length);
            }
        }
    }

    <h2>Når vil du reise fra  @Session["fraLokasjon"] til  @Session["tilLokasjon"]?</h2><br />
    <form action="/Bestilling/regBestilling3" method="post">
        <table style="width: 100%">
            <tr>
                <td><b>Første Avgang</b></td>
                <td><b>Siste Avgang</b></td>
                <td><b>Reisetid</b></td>
                <td><b>Utreise dato</b></td>
                <td><b>Retur dato</b></td>
                <td><b>Spor</b></td>
                <td><b>Tognummer</b></td>
                <td><b>Avreisetid</b></td>
            </tr>
            <tbody id="tabellRad">
                <tr>
                    <td name="fraLokasjon" id="forste"></td>
                    <td name="tilLokasjon" id="siste"></td>
                    <td id="tid"></td>
                    <td >@resultatUt</td>
                    <td></td>
                    <td id="spor"></td>
                    <td id="nr"></td>
                    <td>
                        <select name="avgangstid" id="drop" class="form-control">
                            <option value="" disabled selected>-- Velg avgangstid --</option>
                        </select>
                        <span id="avgangValidering"></span>
                    </td>
                </tr>
            </tbody>

            <tbody id="tabellRadRetur">
                <tr>
                    <td name="tilLokasjon" id="retursiste"></td>
                    <td name="fraLokasjon" id="returforste"></td>
                    <td id="returtid"></td>
                    <td></td>
                    <td id="returDato">@resultatRetur</td>
                    <td id="returspor"></td>
                    <td id="returnr"></td>
                    <td id="dropDownR">
                        <select name="avgangstidRetur" id="dropRetur" class="form-control">
                            <option value="" disabled selected>-- Velg retur avgangstid --</option>
                        </select>
                        <span id="avgangValideringRetur"></span>
                    </td>
                </tr>
            </tbody>

        </table>


        <span id="visValgtAvgang"> <br /> </span><span name="avgangstid" id="avgangstid"></span>
        <span id="visValgtAvgangRetur"> <br /> </span><span name="avgangstidRetur" id="avgangstidRetur"></span>
        <span id="test"></span>
        <input type="submit" value="Bekreft og gå videre til betaling" name="regBestilling3" id="regBestilling3" class="btn btn-success" />
    </form>
</body>

<script>
    $(document).ready(function () {
        var sessionRetur = "@Session["returDato"]";
        if (sessionRetur != "") {
            $("#dropDownR").show();
            $("#tabellRadRetur").show();
        } else {
            $("#dropDownR").hide();
            $("#tabellRadRetur").hide();
        } 
    });
</script>